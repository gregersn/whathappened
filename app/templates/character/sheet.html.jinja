{% extends 'base.html.jinja' %}

{% block head %}
    <meta name="_token" content="{{ csrf_token() }}">
    <script type="text/javascript">
        var csrf_token = "{{ csrf_token() }}";
    </script>

    {% assets "ts_coc" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
{% endblock %}

{% block header %}
  <h1>{% block title %}{{ character.attribute('personalia.Name')}}{% endblock %}</h1>
{% endblock %}

{% block menu %}
    {% if current_user.is_authenticated %}
        <a href="{{ url_for('character.export', id=character['id']) }}">Export</a>
        | <a href="{{ url_for('character.editjson', id=character.id) }}">Edit JSON</a>
    {% endif %}
{% endblock %}

{% macro editable_field(field, default='') -%}
    <span {%- if editable %} class="editable" {% endif -%} data-field="{{field}}">{{ character.attribute(field) or default }}</span>    
{%- endmacro %}

{% macro editable_area(field, default='') -%}
    <div {%- if editable %} class="editable" {% endif -%} data-field="{{field}}" data-type="area">{{ character.attribute(field) or default }}</div>
{%- endmacro %}


{% macro editable_binary(field, default=False) -%}
    {%- if editable %}<input type="checkbox" data-field="{{field}}" data-type="binary" {%- if character.attribute(field) %}checked{%- endif %} />{%- else %}
        {%- if character.attribute(field)%}*{%- else %}&nbsp;&nbsp;{%- endif %}
    {%- endif %}
{%- endmacro %}

{% macro editable_skill(field, subfield=None, default='') -%}
    <span {%- if editable %} class="skill editable" {% endif -%} data-field="{{field}}" data-subfield="{{subfield}}" data-type="skill">{{ character.skill(field, subfield)['value'] }}</span>
    <span class="half"> / {{ character.skill(field, subfield)['value']|half }}</span>
    <span class="fifth"> / {{ character.skill(field, subfield)['value']|fifth }}</span>
{%- endmacro %}

{% macro skill_checkmark(field, subfield=None) -%}
    {%- if editable %}<input type="checkbox" data-field="{{field}}" data-subfield="{{subfield}}" data-type="skillcheck" {%- if character.skill(field, subfield)['checked'] %}checked{%- endif %} />{%- else %}
        {%- if character.skill(field, subfield)['checked'] %}*{%- else %}&nbsp;&nbsp;{%- endif %}
    {%- endif %}
{%- endmacro %}

{% macro editable_weapon(key, weapon) -%}
    {{ key }}
{%- endmacro %}

{% macro editable_lines(key, default) -%}
    {% for item in character.attribute(key) or default %}
        {{ item }}
    {% endfor %}
{%- endmacro %}



{% block content %}
<div class="charactersheet">
    <div class="categories">
        <div class="box personalia">
            <span>Name: </span>{{ editable_field("personalia.Name", "Unknown") }}<br />
            <span>Occupation: </span><span>{{ editable_field("personalia.Occupation", "Unknown") }}</span><br />
            <span>Age: </span>{{ editable_field("personalia.Age", "18") }}
            <span>Sex: </span><span>{{ editable_field('personalia.Gender', 'Unknown')}}</span><br />
            <span>Residence: </span><span>{{ editable_field("personalia.Residence", "Unknown") }}</span><br />
            <span>Birthplace: </span><span>{{ editable_field("personalia.Birthplace", "Unknown") }}</span><br />
        </div>
        <div class="box characteristics">
            <table>
                <tr>
                    <td>STR: {{ editable_field('characteristics.STR') }}</td>
                    <td>DEX: {{ editable_field('characteristics.DEX') }}</td>
                    <td>POW: {{ editable_field('characteristics.POW') }}</td>
                </tr>
                <tr>
                    <td>CON: {{ editable_field('characteristics.CON') }}</td>
                    <td>APP: {{ editable_field('characteristics.APP') }}</td>
                    <td>EDU: {{ editable_field('characteristics.EDU') }}</td>
                </tr>
                <tr>
                    <td>SIZ: {{ editable_field('characteristics.SIZ') }}</td>
                    <td>INT: {{ editable_field('characteristics.INT') }}</td>
                    <td>Move: {{ editable_field('characteristics.Move') }}</td>
                </tr>
            </table>
        </div>
        <div class="box hitpoints">
            Hitpoints<br />
            &nbsp;Current: {{ editable_field("characteristics.HitPts") }} <br />
            &nbsp;Max: {{ editable_field("characteristics.HitPtsMax") }}<br />
            &nbsp;Major wound: {{ editable_binary("characteristics.HitPtsMajorWound") }}
        </div>
        <div class="box sanity">
            Sanity<br />
            &nbsp;Current {{ editable_field('characteristics.Sanity', "0") }}<br />
            &nbsp;Start {{ editable_field('characteristics.SanityStart', "0") }}<br />
            &nbsp;Max: {{ editable_field('characteristics.SanityMax', "99") }} <br />
            &nbsp;Temp insane: {{ editable_binary("characteristics.SanityTemp") }}
            &nbsp;Indefinitely insane: {{ editable_binary("characteristics.SanityIndef") }}
        </div>
        <div class="box magicpoints">
            Magic points <br />
            &nbsp;Current: {{ editable_field('characteristics.MagicPts', "0") }} Max: {{ editable_field('characteristics.MagicPtsMax', "0") }}
        </div>
        <div class="box luck">
            Luck<br />
            &nbsp;Current: {{ editable_field('characteristics.Luck', "0") }} Max: {{ editable_field('characteristics.LuckMax', "0") }}
        </div>
    </div>
    <h3>Investigator skills</h3>
    <div class="skills">
        {% for skill in character.skills() %}
        {% if loop.previtem and loop.previtem['name'] == skill['name'] and loop.previtem['subskill'] == skill['subskill'] %}
        {% else %}
        <div class="skill">
            <span>{{skill_checkmark("skills#" + skill['name'], skill['subskill'] or None ) }}</span>
            
            <span>{{ skill['name'] }}{% if skill['occupation'] %}*{% endif %}{%- if skill['subskill'] and skill['subskill'] != "None" %}: {{ skill['subskill']}} {% endif %}: </span>
            
            <span class="value">{{ editable_skill("skills#" + skill['name'], skill['subskill'] or None, 0)}}</span>
        </div>  
        {% endif %}     
        {% endfor %}
        <div class="skill newskill">
            <form method="POST" action="{{ url_for('character.view', id=character.id) }}">
                {{ skillform.hidden_tag() }} {{ skillform.name(placeholder="New skill...")}}
            </form>
        </div>
    </div>
    <div class="box">
        <h3>Weapons</h3>
        <div class="weapons">
            <table id="tblWeapons" class="editableTable" data-field="weapons">
                <thead>
                    <tr>
                        <th data-property="name">Weapon</th>
                        <th data-property="regular">Regular</th>
                        <th>Hard</th>
                        <th>Extreme</th>
                        <th data-property="damage">Damage</th>
                        <th data-property="range">Range</th>
                        <th data-property="attacks">Attacks</th>
                        <th data-property="ammo">Ammo</th>
                        <th data-property="malf">Malf</th>
                    </tr>
                </thead>
                <tbody>
                {% for weapon in character.attribute('weapons') %}
                    <tr data-row="{{ loop.index }}">
                        <td>{{ weapon['name'] }}</td>
                        <td>{{ weapon['regular'] }}</td>
                        <td>{{ weapon['regular'] | half }}</td>
                        <td>{{ weapon['regular'] | fifth }}</td>
                        <td>{{ weapon['damage'] }}</td>
                        <td>{{ weapon['range'] }}</td>
                        <td>{{ weapon['attacks'] }}</td>
                        <td>{{ weapon['ammo'] }}</td>
                        <td>{{ weapon['malf'] }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>            
        </div>
    </div>
    <div class="box">
        <h3>Combat</h3>
        <div class="combat">
            Damage bonus: {{ editable_field("combat.DamageBonus") }}<br />
            Build: {{ editable_field("combat.Build") }}<br />
            Dodge: {{ editable_field("combat.Dodge") }}<br />
        </div>
    </div>
    <div class="box">
        <h3>Backstory</h3>
        <div class="backstory">
            <div>
                <h4>Personal Description</h4>
                {{ editable_area("backstory.description", "None") }}
            </div>
            <div>
                <h4>Ideology/Beliefs</h4>
                {{ editable_area("backstory.ideology", "None") }}
            </div>
            <div>
                <h4>Significant people</h4>
                {{ editable_area("backstory.people", "None") }}
            </div>
            <div>
                <h4>Meaningful locations</h4>
                {{ editable_area("backstory.locations", "None") }}
            </div>
            <div>
                <h4>Treasured possessions</h4>
                {{ editable_area("backstory.possessions", "None") }}
            </div>
            <div>
                <h4>Traits</h4>
                {{ editable_area("backstory.traits", "None") }}
            </div>
            <div>
                <h4>Injuries & scars</h4>
                {{ editable_area("backstory.injurues", "None") }}
            </div>
            <div>
                <h4>Phobias & manias</h4>
                {{ editable_area("backstory.phobias", "None") }}
            </div>
            <div>
                <h4>Arcane tomes, spells & artifacts</h4>
                {{ editable_area("backstory.tomes", "None") }}
            </div>
            <div>
                <h4>Encounters with strange entities</h4>
                {{ editable_area("backstory.encounters", "None") }}
            </div>
        </div>
    </div>
    <div class="gearpossessions box">
        <h3>Gear &amp; Possessions</h3>
        <ul class="editable_list" data-field="possessions">
        {% for item in character.attribute('possessions') or [] %}
            <li>{{ item }}</li>
        {% endfor %}
        </ul>
    </div>
    <div class="cashassets box">
    <h3>Cash &amp; Assets</h3>
    Spending level: {{ editable_field("cash.spending")}}<br />
    Cash: {{ editable_field("cash.cash")}}<br />
    Assets: {{ editable_field("cash.assets")}}<br />{{ editable_area("assets", "None") }}
    </div>

</div>
{% endblock %}